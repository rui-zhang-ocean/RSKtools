
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>RSKtools for Matlab processing RBR data</title><meta name="generator" content="MATLAB 8.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-07-07"><meta name="DC.source" content="VignettePostProcessing.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>RSKtools for Matlab processing RBR data</h1><!--introduction--><p>RSKtools v2.0.0; RBR Ltd. Ottawa ON, Canada; <a href="mailto:support@rbr-global.com">support@rbr-global.com</a>; 2017-07-07</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Introduction</a></li><li><a href="#2">RSKtools help</a></li><li><a href="#3">Getting set up</a></li><li><a href="#4">Remove atmospheric pressure from measured total pressure</a></li><li><a href="#5">Low-pass filtering</a></li><li><a href="#6">Alignment of conductivity to temperature and pressure</a></li><li><a href="#7">Remove loops</a></li><li><a href="#8">Derive practical salinity</a></li><li><a href="#9">Bin average all channels</a></li><li><a href="#10">Plot the bin averaged profiles</a></li><li><a href="#11">2D plot</a></li><li><a href="#12">Display a summary of all the processing steps</a></li><li><a href="#13">Other Resources</a></li><li><a href="#14">About this document</a></li></ul></div><h2>Introduction<a name="1"></a></h2><p>A suite of new functions are included in RSKtools v2.0.0 to post-process RBR logger data. Below we show how to implement some common processing steps to obtain the highest quality data possible.</p><h2>RSKtools help<a name="2"></a></h2><p>All post-processing functions are customisable with name-value pair input arguments. To process all data using the default parameters no name-value pair arguments are required.  All the information above is available for each function using <tt>help</tt>, for example: <tt>&gt;&gt; help RSKsmooth</tt>.</p><h2>Getting set up<a name="3"></a></h2><p>Review VignetteStandard for help.</p><pre class="codeinput"><span class="comment">% First, open a connection to the RSK logger database file:</span>
file = <span class="string">'sample.rsk'</span>;
rsk = RSKopen(file);

<span class="comment">% read the upcast from profiles 1 - 55</span>
rsk = RSKreadprofiles(rsk, <span class="string">'profile'</span>, 1:55, <span class="string">'direction'</span>, <span class="string">'up'</span>);

<span class="comment">% plot the raw data as profiles</span>
RSKplotprofiles(rsk);
</pre><img vspace="5" hspace="5" src="VignettePostProcessing_01.png" alt=""> <h2>Remove atmospheric pressure from measured total pressure<a name="4"></a></h2><p>We suggest deriving sea pressure first, especially when an atmospheric pressure other than the nominal value of 10.1325 dbar is used, because deriving salinity and depth requires sea pressure.</p><pre class="codeinput">rsk = RSKderiveseapressure(rsk);

<span class="comment">% Hang on to the raw data for plotting later.</span>
raw = rsk;
</pre><h2>Low-pass filtering<a name="5"></a></h2><p>Applying a low pass filter to temperature and conductivity smooths high frequency variability and compensates for differences in sensor time constants (the thermistor often has a slower response to changes than conductivity).  RSKtools includes a function called <tt>RSKsmooth</tt> for this purpose.</p><p>RBR thermistors on profiling instruments have time constants of about 0.6 s, so the conductivity should be smoothed to match that value.  In this example, the logger samples at 6 Hz instrument (<tt>rsk.continuous.samplingPeriod</tt>), so a 7 sample window should provide sufficient smoothing.</p><pre class="codeinput">rsk = RSKsmooth(rsk, {<span class="string">'Conductivity'</span>, <span class="string">'Temperature'</span>}, <span class="string">'windowLength'</span>, 7);
</pre><h2>Alignment of conductivity to temperature and pressure<a name="6"></a></h2><p>Conductivity, temperature, and pressure need to be aligned in time to account for the fact these sensors are not physically co-located on the logger.  At any instant, the sensors are measuring a slightly different parcel of water.  Accounting for this effect ensure that salinity is of high accuracy.</p><p>The classic approach is to compute the salinity for a range of lags, plot each curve, and to manually choose the curve with the smallest salinity spikes at sharp interfaces.  As an alternative, RSKtools provides a function called <tt>RSKcalculateCTlag</tt> that estimates the optimal lag between conductivity and temperature by minimising salinity spiking. See <tt>help RSKcalculateCTlag</tt>.</p><pre class="codeinput">lag = RSKcalculateCTlag(rsk);
rsk = RSKalignchannel(rsk, <span class="string">'Conductivity'</span>, lag);
</pre><h2>Remove loops<a name="7"></a></h2><p>Profiling during rough seas can cause the CTD descent (or ascent) rate to vary, or even temporarily reverse direction.  During such times, the CTD can effectively sample its own wake, potentially degrading the quality of the profile in regions of strong gradients. The measurements taken when the instrument is profiling too slowly or during a pressure reversal should not be used for further analysis. We recommend using <tt>RSKremoveloops</tt> to flag and remove data when the instrument falls below a <tt>threshold</tt> speed. Use <tt>RSKderivedepth</tt> to calculate depth from sea pressure, and <tt>RSKderivevelocity</tt> to calculate profiling rate.</p><pre class="codeinput">rsk = RSKderivedepth(rsk);
rsk = RSKderivevelocity(rsk);

<span class="comment">% Plot the velocity profile to help determine a minimum rate</span>
RSKplotprofiles(rsk,<span class="string">'channel'</span>,{<span class="string">'temperature'</span>,<span class="string">'velocity'</span>},<span class="string">'direction'</span>,<span class="string">'up'</span>);

<span class="comment">% Apply the threshold</span>
rsk = RSKremoveloops(rsk, <span class="string">'threshold'</span>, 0.3);
</pre><img vspace="5" hspace="5" src="VignettePostProcessing_02.png" alt=""> <h2>Derive practical salinity<a name="8"></a></h2><p>RSKtools includes a function to derive Practical Salinity using the TEOS-10 GSW function <tt>gsw_SP_from_C</tt>.  The TEOS-10 GSW Matlab toolbox is freely available from <a href="http://www.teos-10.org/software.htm">http://www.teos-10.org/software.htm</a>.</p><pre class="codeinput">rsk = RSKderivesalinity(rsk);
</pre><h2>Bin average all channels<a name="9"></a></h2><p>Average the data into 0.5 dbar bins using <tt>RSKbinaverage</tt>.</p><pre class="codeinput">rsk = RSKbinaverage(rsk, <span class="string">'binBy'</span>, <span class="string">'Sea Pressure'</span>, <span class="string">'binSize'</span>, 0.5, <span class="string">'direction'</span>, <span class="string">'up'</span>);
</pre><h2>Plot the bin averaged profiles<a name="10"></a></h2><p>Compare the binned data to the raw data for a few example profiles.</p><pre class="codeinput">clf
RSKplotprofiles(raw,<span class="string">'profile'</span>,[1 20 40]);
axhandles = get(gcf,<span class="string">'children'</span>);
<span class="keyword">for</span> k=1:length(axhandles),
  hold(axhandles(k),<span class="string">'on'</span>)
<span class="keyword">end</span>

hdls = RSKplotprofiles(rsk,<span class="string">'profile'</span>,[1 20 40],<span class="keyword">...</span>
                           <span class="string">'channel'</span>,{<span class="string">'conductivity'</span>,<span class="string">'temperature'</span>,<span class="keyword">...</span>
                           <span class="string">'dissolved O2'</span>,<span class="string">'turbidity'</span>,<span class="string">'par'</span>,<span class="string">'chlorophyll'</span>});
set(hdls,{<span class="string">'linewidth'</span>},{2})
</pre><img vspace="5" hspace="5" src="VignettePostProcessing_03.png" alt=""> <h2>2D plot<a name="11"></a></h2><pre class="codeinput">clf
RSKplot2D(rsk, <span class="string">'Salinity'</span>);
</pre><img vspace="5" hspace="5" src="VignettePostProcessing_04.png" alt=""> <h2>Display a summary of all the processing steps<a name="12"></a></h2><p>Type <tt>rsk.log{:,2}</tt> at the command prompt.</p><h2>Other Resources<a name="13"></a></h2><p>VignetteStandard is available for information on getting started with <tt>RSKtools</tt> standard functions.</p><p>A User Manual for <a href="https://docs.rbr-global.com/rsktools">RSKtools</a> is available.</p><h2>About this document<a name="14"></a></h2><p>This document was created using <a href="http://www.mathworks.com/help/matlab/matlab_prog/marking-up-matlab-comments-for-publishing.html">Matlab&#8482; Markup Publishing</a>. To publish it as an HTML page, run the command:</p><pre class="language-matlab">publish(<span class="string">'RSKtools_vignette.m'</span>);
</pre><p>See <tt>help publish</tt> for more document export options.</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% RSKtools for Matlab processing RBR data
% RSKtools v2.0.0;
% RBR Ltd. Ottawa ON, Canada;
% support@rbr-global.com;
% 2017-07-07

%% Introduction
% A suite of new functions are included in RSKtools v2.0.0 to
% post-process RBR logger data. Below we show how to implement some
% common processing steps to obtain the highest quality data possible.

%% RSKtools help
% All post-processing functions are customisable with name-value pair
% input arguments. To process all data using the default parameters
% no name-value pair arguments are required.  All the information
% above is available for each function using |help|, for example:
% |>> help RSKsmooth|.

%% Getting set up
% Review VignetteStandard for help.

% First, open a connection to the RSK logger database file:
file = 'sample.rsk';
rsk = RSKopen(file);

% read the upcast from profiles 1 - 55
rsk = RSKreadprofiles(rsk, 'profile', 1:55, 'direction', 'up');

% plot the raw data as profiles
RSKplotprofiles(rsk);

%% Remove atmospheric pressure from measured total pressure
% We suggest deriving sea pressure first, especially when an
% atmospheric pressure other than the nominal value of 10.1325 dbar is
% used, because deriving salinity and depth requires sea pressure.
rsk = RSKderiveseapressure(rsk);

% Hang on to the raw data for plotting later.
raw = rsk;


%% Low-pass filtering
% Applying a low pass filter to temperature and conductivity
% smooths high frequency variability and compensates for differences
% in sensor time constants (the thermistor often has a slower response
% to changes than conductivity).  RSKtools includes a function called
% |RSKsmooth| for this purpose.  
%
% RBR thermistors on profiling instruments have time constants of
% about 0.6 s, so the conductivity should be smoothed to match that
% value.  In this example, the logger samples at 6 Hz instrument
% (|rsk.continuous.samplingPeriod|), so a 7 sample window should
% provide sufficient smoothing.

rsk = RSKsmooth(rsk, {'Conductivity', 'Temperature'}, 'windowLength', 7);


%% Alignment of conductivity to temperature and pressure 
% Conductivity, temperature, and pressure need to be aligned in time
% to account for the fact these sensors are not physically co-located
% on the logger.  At any instant, the sensors are measuring a slightly
% different parcel of water.  Accounting for this effect ensure that
% salinity is of high accuracy.
%
% The classic approach is to compute the salinity for a range of lags,
% plot each curve, and to manually choose the curve with the smallest
% salinity spikes at sharp interfaces.  As an alternative, RSKtools
% provides a function called |RSKcalculateCTlag| that estimates the
% optimal lag between conductivity and temperature by minimising
% salinity spiking. See |help RSKcalculateCTlag|.

lag = RSKcalculateCTlag(rsk);
rsk = RSKalignchannel(rsk, 'Conductivity', lag);


%% Remove loops
% Profiling during rough seas can cause the CTD descent (or ascent)
% rate to vary, or even temporarily reverse direction.  During such
% times, the CTD can effectively sample its own wake, potentially
% degrading the quality of the profile in regions of strong
% gradients. The measurements taken when the instrument is profiling
% too slowly or during a pressure reversal should not be used for
% further analysis. We recommend using |RSKremoveloops| to flag and
% remove data when the instrument falls below a |threshold| speed.
% Use |RSKderivedepth| to calculate depth from sea pressure, and
% |RSKderivevelocity| to calculate profiling rate.
rsk = RSKderivedepth(rsk);
rsk = RSKderivevelocity(rsk);

% Plot the velocity profile to help determine a minimum rate
RSKplotprofiles(rsk,'channel',{'temperature','velocity'},'direction','up');

% Apply the threshold
rsk = RSKremoveloops(rsk, 'threshold', 0.3);


%% Derive practical salinity
% RSKtools includes a function to derive Practical Salinity using the
% TEOS-10 GSW function |gsw_SP_from_C|.  The TEOS-10 GSW Matlab
% toolbox is freely available from
% <http://www.teos-10.org/software.htm>.
rsk = RSKderivesalinity(rsk);


%% Bin average all channels
% Average the data into 0.5 dbar bins using |RSKbinaverage|.
rsk = RSKbinaverage(rsk, 'binBy', 'Sea Pressure', 'binSize', 0.5, 'direction', 'up');

%% Plot the bin averaged profiles
% Compare the binned data to the raw data for a few example profiles.
clf
RSKplotprofiles(raw,'profile',[1 20 40]);
axhandles = get(gcf,'children');
for k=1:length(axhandles),
  hold(axhandles(k),'on')
end

hdls = RSKplotprofiles(rsk,'profile',[1 20 40],...
                           'channel',{'conductivity','temperature',...
                           'dissolved O2','turbidity','par','chlorophyll'});
set(hdls,{'linewidth'},{2})


%% 2D plot
clf
RSKplot2D(rsk, 'Salinity'); 

%% Display a summary of all the processing steps
% Type |rsk.log{:,2}| at the command prompt.



%% Other Resources
% VignetteStandard is available for information on getting started with
% |RSKtools| standard functions.
%
% A User Manual for <https://docs.rbr-global.com/rsktools RSKtools> is available.


%% About this document
% This document was created using
% <http://www.mathworks.com/help/matlab/matlab_prog/marking-up-matlab-comments-for-publishing.html
% Matlab(TM) Markup Publishing>. To publish it as an HTML page, run the
% command:
%%
% 
%   publish('RSKtools_vignette.m');

%%
% See |help publish| for more document export options.
##### SOURCE END #####
--></body></html>